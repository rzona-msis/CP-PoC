{% extends "base.html" %}

{% block title %}{{ resource.title }} - Campus Resource Hub{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('main.home') }}">Home</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('resources.list_resources') }}">Resources</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ resource.title }}</li>
    </ol>
</nav>

<div class="row">
    <div class="col-lg-8">
        <article aria-labelledby="resource-title">
            <!-- Resource Images -->
            {% if resource.images %}
            <div id="resourceCarousel" class="carousel slide mb-4" data-bs-ride="carousel">
                <div class="carousel-inner">
                    {% for image in resource.images.split(',') %}
                    <div class="carousel-item {% if loop.first %}active{% endif %}">
                        <img src="{{ image }}" class="d-block w-100 rounded" 
                             alt="Image {{ loop.index }} of {{ resource.title }}"
                             style="max-height: 400px; object-fit: cover;">
                    </div>
                    {% endfor %}
                </div>
                {% if resource.images.split(',')|length > 1 %}
                <button class="carousel-control-prev" type="button" data-bs-target="#resourceCarousel" 
                        data-bs-slide="prev" aria-label="Previous image">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#resourceCarousel" 
                        data-bs-slide="next" aria-label="Next image">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                </button>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Resource Details -->
            <header class="mb-4">
                <h1 id="resource-title">{{ resource.title }}</h1>
                <div class="d-flex align-items-center gap-3 mb-3">
                    <span class="badge bg-info">{{ resource.category|replace('_', ' ')|title }}</span>
                    {% if avg_rating %}
                    <div class="star-rating" role="img" aria-label="Average rating {{ avg_rating|round(1) }} out of 5 stars">
                        {% for i in range(1, 6) %}
                            <span class="star {% if i <= avg_rating|round %}{% else %}star-empty{% endif %}" 
                                  aria-hidden="true">★</span>
                        {% endfor %}
                        <span class="ms-2">({{ reviews|length }} reviews)</span>
                    </div>
                    {% endif %}
                </div>
            </header>
            
            <section aria-labelledby="description-heading">
                <h2 id="description-heading" class="h4">Description</h2>
                <p>{{ resource.description }}</p>
            </section>
            
            <section aria-labelledby="details-heading" class="mt-4">
                <h2 id="details-heading" class="h4">Details</h2>
                <dl class="row">
                    <dt class="col-sm-3">Location</dt>
                    <dd class="col-sm-9">{{ resource.location }}</dd>
                    
                    {% if resource.capacity %}
                    <dt class="col-sm-3">Capacity</dt>
                    <dd class="col-sm-9">{{ resource.capacity }} people</dd>
                    {% endif %}
                    
                    <dt class="col-sm-3">Owner</dt>
                    <dd class="col-sm-9">{{ resource.owner.name }}</dd>
                    
                    <dt class="col-sm-3">Requires Approval</dt>
                    <dd class="col-sm-9">{{ 'Yes' if resource.requires_approval else 'No' }}</dd>
                </dl>
            </section>
            
            <!-- Reviews -->
            <section aria-labelledby="reviews-heading" class="mt-5">
                <h2 id="reviews-heading" class="h4">Reviews</h2>
                {% if reviews %}
                <div class="list-group">
                    {% for review in reviews %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <strong>{{ review.reviewer.name }}</strong>
                                <div class="star-rating" role="img" 
                                     aria-label="Rating {{ review.rating }} out of 5 stars">
                                    {% for i in range(1, 6) %}
                                    <span class="star {% if i <= review.rating %}{% else %}star-empty{% endif %}" 
                                          aria-hidden="true">★</span>
                                    {% endfor %}
                                </div>
                            </div>
                            <small class="text-muted">{{ review.timestamp.strftime('%Y-%m-%d') }}</small>
                        </div>
                        {% if review.comment %}
                        <p class="mb-0">{{ review.comment }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">No reviews yet. Be the first to review!</p>
                {% endif %}
            </section>
        </article>
    </div>
    
    <!-- Sidebar Actions -->
    <aside class="col-lg-4" aria-labelledby="actions-heading">
        <h2 id="actions-heading" class="visually-hidden">Actions</h2>
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-body">
                {% if current_user.is_authenticated %}
                <a href="{{ url_for('bookings.create_booking', resource_id=resource.resource_id) }}" 
                   class="btn btn-primary btn-lg w-100 mb-3"
                   aria-label="Book {{ resource.title }}">
                    Book This Resource
                </a>
                
                <a href="{{ url_for('reviews.create_review', resource_id=resource.resource_id) }}" 
                   class="btn btn-outline-secondary w-100 mb-3">
                    Write a Review
                </a>
                
                <a href="{{ url_for('messages.send_message', receiver_id=resource.owner_id) }}" 
                   class="btn btn-outline-secondary w-100">
                    Contact Owner
                </a>
                
                {% if current_user.user_id == resource.owner_id or current_user.is_admin() %}
                <hr>
                <h3 class="h6">Owner Actions</h3>
                <a href="{{ url_for('resources.edit', resource_id=resource.resource_id) }}" 
                   class="btn btn-sm btn-outline-primary w-100 mb-2">
                    Edit Resource
                </a>
                <form method="POST" action="{{ url_for('resources.delete', resource_id=resource.resource_id) }}" 
                      onsubmit="return confirm('Are you sure you want to delete this resource?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-sm btn-outline-danger w-100">
                        Delete Resource
                    </button>
                </form>
                {% endif %}
                
                {% else %}
                <p class="text-center mb-3">Please login to book this resource</p>
                <a href="{{ url_for('auth.login') }}" class="btn btn-primary w-100">
                    Login
                </a>
                {% endif %}
            </div>
        </div>
    </aside>
</div>
{% endblock %}
