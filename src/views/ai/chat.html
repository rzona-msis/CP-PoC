{% extends "base.html" %}

{% block title %}AI Resource Assistant - Campus Resource Hub{% endblock %}

{% block extra_css %}
<style>
    /* Additional chat-specific styles - Indiana University Theme */
    .chat-container {
        height: 600px;
        display: flex;
        flex-direction: column;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(153, 0, 0, 0.15);
        border: 1px solid var(--iu-cream);
    }
    
    .chat-header {
        background: linear-gradient(135deg, var(--iu-crimson) 0%, #7a0000 100%);
        color: var(--iu-cream);
        padding: 1.5rem;
        border-radius: 10px 10px 0 0;
        border-bottom: 3px solid var(--iu-cream);
    }
    
    .chat-header h5 {
        color: var(--iu-cream);
        font-weight: 600;
        font-family: 'Georgia', serif;
    }
    
    .chat-header small {
        color: rgba(242, 239, 234, 0.9);
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        background: var(--iu-light-gray);
    }
    
    .message {
        margin-bottom: 1rem;
        display: flex;
        align-items: flex-start;
    }
    
    .message.user {
        flex-direction: row-reverse;
    }
    
    .message-bubble {
        max-width: 70%;
        padding: 0.75rem 1rem;
        border-radius: 18px;
        word-wrap: break-word;
        font-family: 'Georgia', serif;
    }
    
    .message.user .message-bubble {
        background: var(--iu-crimson);
        color: var(--iu-cream);
        margin-left: auto;
        box-shadow: 0 2px 6px rgba(153, 0, 0, 0.2);
    }
    
    .message.assistant .message-bubble {
        background: white;
        border: 2px solid var(--iu-cream);
        color: var(--iu-text-color);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    
    .message-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        margin: 0 0.5rem;
        border: 2px solid var(--iu-cream);
    }
    
    .message.user .message-avatar {
        background: var(--iu-crimson);
        color: var(--iu-cream);
    }
    
    .message.assistant .message-avatar {
        background: var(--iu-cream);
        color: var(--iu-crimson);
    }
    
    .chat-input-area {
        padding: 1rem;
        background: white;
        border-top: 2px solid var(--iu-cream);
        border-radius: 0 0 10px 10px;
    }
    
    .resource-card {
        background: white;
        border: 2px solid var(--iu-cream);
        border-radius: 8px;
        padding: 0.75rem;
        margin-top: 0.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .resource-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(153, 0, 0, 0.2);
        border-color: var(--iu-crimson);
    }
    
    .resource-card strong {
        color: var(--iu-crimson);
    }
    
    .suggestions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    
    .suggestion-chip {
        background: var(--iu-cream);
        border: 2px solid var(--iu-crimson);
        border-radius: 20px;
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.3s ease;
        color: var(--iu-crimson);
        font-weight: 500;
    }
    
    .suggestion-chip:hover {
        background: var(--iu-crimson);
        color: var(--iu-cream);
        transform: translateY(-2px);
        box-shadow: 0 2px 6px rgba(153, 0, 0, 0.3);
    }
    
    .typing-indicator {
        display: none;
        padding: 0.5rem;
    }
    
    .typing-indicator.active {
        display: block;
    }
    
    .typing-dots span {
        display: inline-block;
        width: 8px;
        height: 8px;
        background: var(--iu-crimson);
        border-radius: 50%;
        margin: 0 2px;
        animation: typing 1.4s infinite;
    }
    
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-10px); }
    }
    
    .ai-badge {
        display: inline-block;
        background: #2d7a2e;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        margin-left: 0.5rem;
        font-family: 'Georgia', serif;
        font-weight: 600;
        border: 1px solid white;
    }
    
    /* Scrollbar styling for chat */
    .chat-messages::-webkit-scrollbar {
        width: 8px;
    }
    
    .chat-messages::-webkit-scrollbar-track {
        background: var(--iu-light-gray);
    }
    
    .chat-messages::-webkit-scrollbar-thumb {
        background: var(--iu-crimson);
        border-radius: 4px;
    }
    
    .chat-messages::-webkit-scrollbar-thumb:hover {
        background: #7a0000;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">
            <div class="mb-3">
                <h1><i class="bi bi-robot"></i> AI Resource Assistant <span class="ai-badge" id="ai-status">Loading...</span></h1>
                <p class="text-muted">Ask me anything about campus resources, and I'll help you find what you need!</p>
            </div>
            
            <div class="chat-container">
                <div class="chat-header">
                    <h5 class="mb-1"><i class="bi bi-chat-dots"></i> Resource Concierge</h5>
                    <small>Powered by AI - Ask me about study rooms, equipment, or event spaces</small>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <!-- Welcome message -->
                    <div class="message assistant">
                        <div class="message-avatar">
                            <i class="bi bi-robot"></i>
                        </div>
                        <div class="message-bubble">
                            <strong>Hello! ðŸ‘‹</strong><br>
                            I'm your AI assistant for finding campus resources. I can help you:
                            <ul class="mb-0 mt-2">
                                <li>Find study rooms and quiet spaces</li>
                                <li>Locate equipment and technology</li>
                                <li>Discover event venues</li>
                                <li>Check availability and book resources</li>
                            </ul>
                            <p class="mb-0 mt-2">What are you looking for today?</p>
                        </div>
                    </div>
                </div>
                
                <div class="typing-indicator" id="typingIndicator">
                    <div class="message assistant">
                        <div class="message-avatar">
                            <i class="bi bi-robot"></i>
                        </div>
                        <div class="message-bubble">
                            <div class="typing-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="chat-input-area">
                    <form id="chatForm">
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control" 
                                   id="messageInput" 
                                   placeholder="Type your message... (e.g., 'I need a quiet study room')"
                                   autocomplete="off"
                                   required>
                            <button class="btn btn-primary" type="submit" id="sendButton">
                                <i class="bi bi-send"></i> Send
                            </button>
                        </div>
                    </form>
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="bi bi-lightbulb"></i> Try: "Find me a study room for tomorrow" or "I need video equipment"
                        </small>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-3">
                <button class="btn btn-sm btn-outline-secondary" id="clearChat">
                    <i class="bi bi-trash"></i> Clear Chat
                </button>
                <a href="{{ url_for('resources.list_resources') }}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-search"></i> Browse All Resources
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const chatMessages = document.getElementById('chatMessages');
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const typingIndicator = document.getElementById('typingIndicator');
    const clearChatBtn = document.getElementById('clearChat');
    const aiStatusBadge = document.getElementById('ai-status');
    
    let conversationHistory = [];
    
    // Check AI status
    fetch('/ai/api/chat/status')
        .then(res => res.json())
        .then(data => {
            if (data.enabled && data.features.natural_language) {
                aiStatusBadge.textContent = 'âœ“ AI Enabled';
                aiStatusBadge.className = 'ai-badge';
                aiStatusBadge.style.background = '#4caf50';
            } else {
                aiStatusBadge.textContent = 'Keyword Mode';
                aiStatusBadge.className = 'ai-badge';
                aiStatusBadge.style.background = '#ff9800';
            }
        });
    
    // Handle form submission
    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const message = messageInput.value.trim();
        if (!message) return;
        
        // Add user message to chat
        addMessage('user', message);
        messageInput.value = '';
        
        // Disable input while processing
        messageInput.disabled = true;
        sendButton.disabled = true;
        typingIndicator.classList.add('active');
        
        try {
            const response = await fetch('/ai/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    conversation_history: conversationHistory
                })
            });
            
            const data = await response.json();
            
            // Add AI response
            addMessage('assistant', data.response, data.resources, data.suggestions);
            
            // Update conversation history
            conversationHistory.push(
                { role: 'user', content: message },
                { role: 'assistant', content: data.response }
            );
            
            // Keep only last 10 messages
            if (conversationHistory.length > 10) {
                conversationHistory = conversationHistory.slice(-10);
            }
            
        } catch (error) {
            addMessage('assistant', 'Sorry, I encountered an error. Please try again.');
            console.error('Chat error:', error);
        }
        
        // Re-enable input
        messageInput.disabled = false;
        sendButton.disabled = false;
        typingIndicator.classList.remove('active');
        messageInput.focus();
    });
    
    function addMessage(role, content, resources = [], suggestions = []) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;
        
        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.innerHTML = role === 'user' ? '<i class="bi bi-person-circle"></i>' : '<i class="bi bi-robot"></i>';
        
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        bubble.innerHTML = content.replace(/\n/g, '<br>');
        
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(bubble);
        
        // Add resources if any
        if (resources && resources.length > 0) {
            const resourcesDiv = document.createElement('div');
            resourcesDiv.className = 'mt-2';
            resources.forEach(resource => {
                const card = document.createElement('div');
                card.className = 'resource-card';
                card.innerHTML = `
                    <strong>${resource.title}</strong><br>
                    <small class="text-muted">
                        <i class="bi bi-geo-alt"></i> ${resource.location || 'Location TBD'} | 
                        <i class="bi bi-star-fill text-warning"></i> ${resource.rating ? resource.rating.toFixed(1) : 'N/A'}
                    </small><br>
                    <small>${resource.description ? resource.description.substring(0, 100) + '...' : ''}</small>
                `;
                card.onclick = () => {
                    window.location.href = `/resources/${resource.resource_id}`;
                };
                resourcesDiv.appendChild(card);
            });
            bubble.appendChild(resourcesDiv);
        }
        
        // Add suggestions if any
        if (suggestions && suggestions.length > 0) {
            const suggestionsDiv = document.createElement('div');
            suggestionsDiv.className = 'suggestions';
            suggestions.forEach(suggestion => {
                const chip = document.createElement('span');
                chip.className = 'suggestion-chip';
                chip.textContent = suggestion.text;
                chip.onclick = () => {
                    if (suggestion.action === 'show_resources' && resources.length > 0) {
                        // Already showing resources above
                    } else if (suggestion.action === 'browse') {
                        window.location.href = '/resources/';
                    } else if (suggestion.action === 'filter_category') {
                        window.location.href = `/resources/?category=${suggestion.category}`;
                    }
                };
                suggestionsDiv.appendChild(chip);
            });
            bubble.appendChild(suggestionsDiv);
        }
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Clear chat
    clearChatBtn.addEventListener('click', async () => {
        if (confirm('Clear chat history?')) {
            await fetch('/ai/api/chat/clear', { method: 'POST' });
            conversationHistory = [];
            chatMessages.innerHTML = `
                <div class="message assistant">
                    <div class="message-avatar">
                        <i class="bi bi-robot"></i>
                    </div>
                    <div class="message-bubble">
                        Chat cleared! How can I help you?
                    </div>
                </div>
            `;
        }
    });
    
    // Focus input on load
    messageInput.focus();
</script>
{% endblock %}

