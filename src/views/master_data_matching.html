{% extends "base.html" %}
{% block title %}AI Master Data Matching - TMHNA{% endblock %}

{% block content %}
<div class="sp-main-container">
    <div class="sp-page-header">
        <h1 class="sp-page-title">
            <i class="bi bi-diagram-3"></i> AI Master Data Matching Tool
        </h1>
    </div>
    
    <!-- Entity Selection Section -->
    <div class="sp-section-card">
        <div class="sp-card-header">
            <h2 class="sp-card-title"><i class="bi bi-search"></i> Find Duplicate Records</h2>
        </div>
        <div class="sp-card-body">
            <form id="duplicateForm">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="entityType" class="form-label"><strong>Entity Type</strong></label>
                        <select class="form-select form-select-lg" id="entityType" required>
                            <option value="">-- Select Entity Type --</option>
                            <option value="customer">Customers</option>
                            <option value="vendor">Vendors</option>
                            <option value="product">Products</option>
                        </select>
                    </div>
                    <div class="col-md-3" id="searchFieldContainer" style="display: none;">
                        <label for="searchField" class="form-label"><strong>Search Field</strong></label>
                        <select class="form-select form-select-lg" id="searchField">
                            <option value="all">All Fields</option>
                            <option value="name">Name Only</option>
                            <option value="email">Email Only</option>
                            <option value="phone">Phone Only</option>
                            <option value="address">Address Only</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="threshold" class="form-label"><strong>Similarity Threshold</strong></label>
                        <input type="range" class="form-range" id="threshold" min="0.5" max="1.0" step="0.05" value="0.7">
                        <div class="text-center"><span id="thresholdValue">0.70</span></div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"><strong>Use AI Scoring</strong></label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="useLLM" checked>
                            <label class="form-check-label" for="useLLM">
                                Enable LLM Analysis
                            </label>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-success btn-lg" id="findBtn">
                            <i class="bi bi-search"></i> Find Duplicates
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="text-center py-5" style="display: none;">
        <div class="spinner-border text-success" style="width: 3rem; height: 3rem;"></div>
        <p class="mt-3 h5">ðŸ¤– Analyzing for duplicates...</p>
    </div>
    
    <!-- Results Panel -->
    <div id="resultsPanel" style="display: none;">
        <div class="sp-section-card mb-3">
            <div class="sp-card-body">
                <div class="alert alert-info mb-3">
                    <strong>Found <span id="duplicateCount">0</span> potential duplicate pairs</strong>
                </div>
                
                <!-- Search and Filter Controls -->
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="searchInput" class="form-label"><strong>Search Records</strong></label>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search by any field...">
                    </div>
                    <div class="col-md-3">
                        <label for="fieldFilter" class="form-label"><strong>Filter by Field</strong></label>
                        <select class="form-select" id="fieldFilter">
                            <option value="all">All Fields</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="confidenceFilter" class="form-label"><strong>Min Confidence</strong></label>
                        <select class="form-select" id="confidenceFilter">
                            <option value="0">All Matches</option>
                            <option value="60">60% and above</option>
                            <option value="70">70% and above</option>
                            <option value="80">80% and above</option>
                            <option value="90">90% and above</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="duplicatesList"></div>
    </div>
</div>

<script>
// VERSION 3.0 - CACHE BUSTER
// Threshold slider
document.getElementById('threshold').addEventListener('input', function() {
    document.getElementById('thresholdValue').textContent = parseFloat(this.value).toFixed(2);
});

// Dynamically update search field options based on entity type
document.getElementById('entityType').addEventListener('change', function() {
    const entityType = this.value;
    const searchField = document.getElementById('searchField');
    
    // Define field options for each entity type
    const fieldOptions = {
        'customer': [
            { value: 'all', label: 'All Fields' },
            { value: 'name', label: 'Name Only' },
            { value: 'email', label: 'Email Only' },
            { value: 'phone', label: 'Phone Only' },
            { value: 'address', label: 'Address Only' }
        ],
        'vendor': [
            { value: 'all', label: 'All Fields' },
            { value: 'name', label: 'Name Only' },
            { value: 'contact_email', label: 'Email Only' },
            { value: 'phone', label: 'Phone Only' },
            { value: 'address', label: 'Address Only' }
        ],
        'product': [
            { value: 'all', label: 'All Fields' },
            { value: 'name', label: 'Name Only' },
            { value: 'sku', label: 'SKU Only' },
            { value: 'category', label: 'Category Only' }
        ]
    };
    
    // Clear existing options
    searchField.innerHTML = '';
    
    // Add options based on selected entity type
    if (entityType && fieldOptions[entityType]) {
        fieldOptions[entityType].forEach(option => {
            const opt = document.createElement('option');
            opt.value = option.value;
            opt.textContent = option.label;
            searchField.appendChild(opt);
        });
    } else {
        // Default options if no entity selected
        const opt = document.createElement('option');
        opt.value = 'all';
        opt.textContent = 'All Fields';
        searchField.appendChild(opt);
    }
});

// Form submission
document.getElementById('duplicateForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const entityType = document.getElementById('entityType').value;
    const threshold = parseFloat(document.getElementById('threshold').value);
    const useLLM = document.getElementById('useLLM').checked;
    const searchField = document.getElementById('searchField').value;
    
    console.log('=== Starting Duplicate Search ===');
    console.log('Entity Type:', entityType);
    console.log('Threshold:', threshold);
    console.log('Use LLM:', useLLM);
    console.log('Search Field:', searchField);
    
    if (!entityType) {
        alert('Please select an entity type');
        return;
    }
    
    const loadingSpinner = document.getElementById('loadingSpinner');
    const resultsPanel = document.getElementById('resultsPanel');
    const findBtn = document.getElementById('findBtn');
    
    // Reset previous results and state
    window.originalDuplicates = [];
    window.currentEntityType = null;
    const duplicatesList = document.getElementById('duplicatesList');
    if (duplicatesList) {
        duplicatesList.innerHTML = '';
    }
    
    loadingSpinner.style.display = 'block';
    // Don't hide the panel if it's already visible - just clear content
    // resultsPanel.style.display = 'none';
    findBtn.disabled = true;
    
    try {
        const response = await fetch('/api/find-duplicates', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                entity_type: entityType,
                threshold: threshold,
                use_llm: useLLM,
                search_field: searchField
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Show results panel FIRST
            resultsPanel.style.display = 'block';
            
            // Use setTimeout to ensure browser has rendered the visible panel
            setTimeout(() => {
                console.log('=== TIMEOUT VERSION - Accessing elements after render ===');
                console.log('resultsPanel HTML:', resultsPanel.innerHTML.substring(0, 500));
                
                // Try to find existing elements
                let countElement = resultsPanel.querySelector('#duplicateCount');
                const listElement = resultsPanel.querySelector('#duplicatesList');
                let countElement2 = document.getElementById('duplicateCount');
                
                console.log('countElement (querySelector):', countElement);
                console.log('countElement (getElementById):', countElement2);
                console.log('listElement:', listElement);
                
                // If countElement doesn't exist, recreate it
                if (!countElement && !countElement2) {
                    console.warn('duplicateCount element missing - recreating');
                    const cardBody = resultsPanel.querySelector('.sp-card-body');
                    if (cardBody) {
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-info mb-3';
                        alertDiv.innerHTML = '<strong>Found <span id="duplicateCount">0</span> potential duplicate pairs</strong>';
                        cardBody.insertBefore(alertDiv, cardBody.firstChild);
                        countElement2 = document.getElementById('duplicateCount');
                        console.log('Recreated countElement:', countElement2);
                    }
                }
                
                // Use whichever method finds the element
                const finalCountElement = countElement || countElement2;
                
                if (finalCountElement && listElement) {
                    finalCountElement.textContent = data.duplicate_count || 0;
                    
                    // Store original duplicates data globally
                    window.originalDuplicates = data.duplicates || [];
                    window.currentEntityType = entityType;
                    
                    // Populate field filter dropdown based on entity type
                    populateFieldFilter(entityType);
                    
                    displayDuplicates(window.originalDuplicates, entityType);
                    
                    // Show the search field after finding duplicates
                    const searchFieldContainer = document.getElementById('searchFieldContainer');
                    if (searchFieldContainer) {
                        searchFieldContainer.style.display = 'block';
                    }
                    
                    // Set up search and filter event listeners
                    setupSearchAndFilters();
                    
                    // Scroll to results
                    resultsPanel.scrollIntoView({ behavior: 'smooth' });
                } else {
                    console.error('Required DOM elements not found', {
                        countElement: !!finalCountElement,
                        listElement: !!listElement
                    });
                }
            }, 50); // Small delay to let browser render
        } else {
            alert('Error: ' + (data.error || 'Unknown error occurred'));
            // Clear results on error
            resultsPanel.style.display = 'none';
        }
    } catch (error) {
        console.error('Request error:', error);
        alert('Request failed: ' + error.message);
        // Clear results on error
        resultsPanel.style.display = 'none';
    } finally {
        loadingSpinner.style.display = 'none';
        findBtn.disabled = false;
        // Re-enable form inputs
        document.getElementById('entityType').disabled = false;
        document.getElementById('threshold').disabled = false;
        document.getElementById('useLLM').disabled = false;
    }
});

function displayDuplicates(duplicates, entityType) {
    const container = document.getElementById('duplicatesList');
    
    if (duplicates.length === 0) {
        container.innerHTML = '<div class="alert alert-success">No duplicates found!</div>';
        return;
    }
    
    container.innerHTML = duplicates.map((dup, index) => {
        const confidenceClass = dup.confidence_score >= 80 ? 'success' : 
                               dup.confidence_score >= 60 ? 'warning' : 'secondary';
        
        return `
            <div class="sp-section-card">
                <div class="sp-card-header">
                    <div class="row align-items-center">
                        <div class="col">
                            <h2 class="sp-card-title mb-0">Duplicate Pair ${index + 1}</h2>
                        </div>
                        <div class="col-auto">
                            <span class="badge bg-${confidenceClass} fs-6">
                                ${dup.confidence_score.toFixed(1)}% Confidence
                            </span>
                        </div>
                    </div>
                </div>
                <div class="sp-card-body">
                    <div class="row">
                        <div class="col-md-5">
                            <h6 class="text-primary">Record A (${dup.entity_a.source_system || 'Unknown'})</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    ${formatEntityTable(dup.entity_a, entityType)}
                                </table>
                            </div>
                        </div>
                        <div class="col-md-2 text-center d-flex align-items-center justify-content-center">
                            <div>
                                <i class="bi bi-arrow-left-right text-warning" style="font-size: 2rem;"></i>
                                <p class="text-muted small mt-2">${dup.match_reason || ''}</p>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <h6 class="text-primary">Record B (${dup.entity_b.source_system || 'Unknown'})</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    ${formatEntityTable(dup.entity_b, entityType)}
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-success" onclick="approveMatch(${dup.match_id})">
                            <i class="bi bi-check-circle"></i> Approve Match
                        </button>
                        <button class="btn btn-danger" onclick="rejectMatch(${dup.match_id})">
                            <i class="bi bi-x-circle"></i> Reject
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function formatEntityTable(entity, entityType) {
    const fields = entityType === 'customer' ? 
        ['customer_name', 'email', 'phone', 'address', 'city', 'state'] :
        entityType === 'vendor' ? 
        ['vendor_name', 'contact_email', 'phone', 'address', 'city', 'state'] :
        ['product_name', 'sku', 'category', 'unit_cost'];
    
    return fields.map(field => {
        const value = entity[field] !== undefined ? entity[field] : '-';
        return `<tr><th class="text-nowrap">${field}</th><td>${escapeHtml(String(value))}</td></tr>`;
    }).join('');
}

async function approveMatch(matchId) {
    if (!confirm('Approve this duplicate match?')) return;
    
    try {
        const response = await fetch('/api/update-match-status', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                match_id: matchId,
                status: 'approved',
                reviewed_by: 'User'
            })
        });
        
        const data = await response.json();
        if (data.success) {
            alert('Match approved!');
            location.reload();
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function rejectMatch(matchId) {
    if (!confirm('Reject this duplicate match?')) return;
    
    try {
        const response = await fetch('/api/update-match-status', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                match_id: matchId,
                status: 'rejected',
                reviewed_by: 'User'
            })
        });
        
        const data = await response.json();
        if (data.success) {
            alert('Match rejected!');
            location.reload();
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function populateFieldFilter(entityType) {
    const fieldFilter = document.getElementById('fieldFilter');
    
    // Check if element exists
    if (!fieldFilter) {
        console.error('Field filter element not found');
        return;
    }
    
    // Define fields for each entity type
    const fieldsByType = {
        'customer': [
            { value: 'all', label: 'All Fields' },
            { value: 'customer_name', label: 'Customer Name' },
            { value: 'email', label: 'Email' },
            { value: 'phone', label: 'Phone' },
            { value: 'address', label: 'Address' },
            { value: 'city', label: 'City' },
            { value: 'state', label: 'State' }
        ],
        'vendor': [
            { value: 'all', label: 'All Fields' },
            { value: 'vendor_name', label: 'Vendor Name' },
            { value: 'contact_email', label: 'Email' },
            { value: 'phone', label: 'Phone' },
            { value: 'address', label: 'Address' },
            { value: 'city', label: 'City' },
            { value: 'state', label: 'State' }
        ],
        'product': [
            { value: 'all', label: 'All Fields' },
            { value: 'product_name', label: 'Product Name' },
            { value: 'sku', label: 'SKU' },
            { value: 'category', label: 'Category' },
            { value: 'unit_cost', label: 'Unit Cost' }
        ]
    };
    
    // Clear and populate
    fieldFilter.innerHTML = '';
    const fields = fieldsByType[entityType] || fieldsByType['customer'];
    fields.forEach(field => {
        const option = document.createElement('option');
        option.value = field.value;
        option.textContent = field.label;
        fieldFilter.appendChild(option);
    });
}

function setupSearchAndFilters() {
    console.log('setupSearchAndFilters: Attempting to set up filters');
    
    const searchInput = document.getElementById('searchInput');
    const fieldFilter = document.getElementById('fieldFilter');
    const confidenceFilter = document.getElementById('confidenceFilter');
    
    console.log('Element check:', {
        searchInput: !!searchInput,
        fieldFilter: !!fieldFilter,
        confidenceFilter: !!confidenceFilter,
        alreadyInitialized: !!window.filtersInitialized
    });
    
    // If elements don't exist, just return silently
    if (!searchInput || !fieldFilter || !confidenceFilter) {
        console.warn('Some filter elements not found, skipping setup');
        return;
    }
    
    // Only set up listeners once
    if (!window.filtersInitialized) {
        const applyFilters = () => {
            try {
                filterAndDisplayDuplicates();
            } catch (e) {
                console.error('Error in filterAndDisplayDuplicates:', e);
            }
        };
        
        searchInput.addEventListener('input', applyFilters);
        fieldFilter.addEventListener('change', applyFilters);
        confidenceFilter.addEventListener('change', applyFilters);
        
        window.filtersInitialized = true;
        console.log('âœ“ Event listeners attached successfully');
    } else {
        console.log('Filters already initialized, reusing existing listeners');
    }
}

function filterAndDisplayDuplicates() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const fieldFilter = document.getElementById('fieldFilter').value;
    const minConfidence = parseFloat(document.getElementById('confidenceFilter').value);
    
    let filtered = window.originalDuplicates.filter(dup => {
        // Filter by confidence
        if (dup.confidence_score < minConfidence) return false;
        
        // Filter by search term
        if (searchTerm) {
            const entityA = dup.entity_a;
            const entityB = dup.entity_b;
            
            // If specific field selected, search only in that field
            if (fieldFilter !== 'all') {
                const valueA = String(entityA[fieldFilter] || '').toLowerCase();
                const valueB = String(entityB[fieldFilter] || '').toLowerCase();
                return valueA.includes(searchTerm) || valueB.includes(searchTerm);
            } else {
                // Search all fields
                const allValuesA = Object.values(entityA).map(v => String(v).toLowerCase()).join(' ');
                const allValuesB = Object.values(entityB).map(v => String(v).toLowerCase()).join(' ');
                return allValuesA.includes(searchTerm) || allValuesB.includes(searchTerm);
            }
        }
        
        return true;
    });
    
    // Update count and display
    document.getElementById('duplicateCount').textContent = filtered.length;
    displayDuplicates(filtered, window.currentEntityType);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
